
# Prompt for credentials
$username = Read-Host "Enter your Emp ID"
$password = Read-Host "Enter your Password" -AsSecureString
$plainPassword = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto(
    [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($password)
)

# Encode credentials for Basic Auth
$encodedCreds = [Convert]::ToBase64String(
    [Text.Encoding]::UTF8.GetBytes("$($username):$($plainPassword)")
)
$basicAuthValue = "Basic $encodedCreds"

# API URLs
$priorWeekUrl = "https://udeploy.nnnn.net:8443/rest/report/adHoc?dateRange=priorWeek&orderField=application&sortType=asc&type=com.urbancode.ds.subsys.report.domain"

# Set HTTP headers
$headers = @{
    Authorization = $basicAuthValue
}

# Output CSV file
$outputFile = ".\UCD_Prod_Report.csv"
"Application Name,Environment Name,User Name,Start Time,End Time,Component Name,Component Version,Commit URL" | Out-File -FilePath $outputFile -Force

# Fetch application process requests for the prior week
$response = Invoke-WebRequest -Uri $priorWeekUrl -Method Get -Headers $headers
$responseContent = $response.Content | ConvertFrom-Json

# Process each deployment request
$responseContent.items | ForEach-Object {
    $appName = $_.applicationName
    $envName = $_.environmentName
    $userName = $_.userName
    $startTimeUnix = $_.startTime
    $endTimeUnix = $_.endTime

    # Convert UNIX timestamps to local time
    $startTime = (Get-Date "1/1/1970").AddSeconds([int64]([math]::Truncate($startTimeUnix / 1000))).ToLocalTime()
    $endTime = (Get-Date "1/1/1970").AddSeconds([int64]([math]::Truncate($endTimeUnix / 1000))).ToLocalTime()

    # Extract application request ID
    $appRequestID = $_.applicationRequestId
    $appRequestUrl = "https://udeploy.nnnn.net:8443/cli/applicationProcessRequest/info/$appRequestID"

    # Fetch process request details
    $appResponse = Invoke-WebRequest -Uri $appRequestUrl -Method Get -Headers $headers
    $appRequestJson = $appResponse.Content | ConvertFrom-Json

    # Initialize empty flag
    $snapshotEmpty = $true

    # Check for snapshots
    if ($null -ne $appRequestJson.snapshot.id) {
        $snapshotID = $appRequestJson.snapshot.id
        $snapshotUrl = "https://udeploy.nnnn.net:8443/cli/snapshot/getSnapshotVersions?application=$($appRequestJson.application.id)&snapshot=$snapshotID"
        $snapshotResponse = Invoke-WebRequest -Uri $snapshotUrl -Method Get -Headers $headers
        $snapshotJson = $snapshotResponse.Content | ConvertFrom-Json

        # Extract component versions from the snapshot if available
        $snapshotJson | ForEach-Object {
            if ($_.desiredVersions.name) {
                $compName = $_.name
                $compVersion = $_.desiredVersions.name
                $commitURL = $_.desiredVersions.commitUrl
                "$appName,$envName,$userName,$startTime,$endTime,$compName,$compVersion,$commitURL" | Out-File -FilePath $outputFile -Append
                $snapshotEmpty = $false
            }
        }
    }

    # If snapshot is empty OR environment is non-prod, fetch manifest versions
    if ($snapshotEmpty -or $envName -notmatch "PRD|PROD") {
        $manifestUrl = "https://udeploy.nnnn.net:8443/cli/applicationProcessRequest/request/$appRequestID"
        $manifestResponse = Invoke-WebRequest -Uri $manifestUrl -Method Get -Headers $headers
        $manifestJson = $manifestResponse.Content | ConvertFrom-Json

        # Extract versions from the manifest
        $manifestJson.versions | ForEach-Object {
            $compName = $_.componentName
            $compVersion = $_.versionName
            $commitURL = $_.commitUrl

            if ($null -ne $compVersion) {
                "$appName,$envName,$userName,$startTime,$endTime,$compName,$compVersion,$commitURL" | Out-File -FilePath $outputFile -Append
            }
        }
    }
}

Write-Output "Report generation complete. File saved to $outputFile."































# Define your UCD server details and credentials
$UCDServer = "https://your-ucd-server.example.com"
$Username = "your-username"
$Password = "your-password"
$ApplicationName = "aaaaaa"  # Specify the application name

# Basic authentication for UCD
$Base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes((":$Password")))

# Create a new file for the UCD Report (CSV format)
$UCDReport = New-Item -ItemType File -Path .\UCD_Report.csv -Force

# Add header to the CSV file
Add-Content -Path $UCDReport.FullName -Value "Application Name, Environment Name, Snapshot ID, Snapshot Name, User Name, Start Time, End Time, Component Name, Component Version"

# Login and fetch application data
$uri = "$UCDServer/rest/applications/$ApplicationName"

# Fetch the application details
$response = Invoke-RestMethod -Uri $uri -Method Get -Headers @{Authorization=("Basic {0}" -f $Base64AuthInfo)} -ContentType "application/json"

# Loop through environments and extract data for each environment
foreach ($environment in $response.environments) {
    $EnvName = $environment.name

    # Fetch environment details including snapshot and component information
    $snapshots = $environment.snapshots
    $components = $environment.components

    foreach ($snapshot in $snapshots) {
        # If no snapshot, set to No Snapshot
        $SnapshotID = if ($snapshot -eq $null) { "No Snapshot" } else { $snapshot.id }
        $SnapshotName = if ($snapshot -eq $null) { "No Snapshot" } else { $snapshot.name }

        foreach ($component in $components) {
            $ComponentName = $component.name
            $ComponentVersion = $component.version

            # Assuming other fields like start time and end time are available from the response
            $StartTimeUnix = $environment.startTime
            $EndTimeUnix = $environment.endTime
            $UserName = $environment.userName

            # Convert the start and end times from Unix format to DateTime
            $StartTime = [System.DateTime]::FromFileTimeUtc($StartTimeUnix)
            $EndTime = [System.DateTime]::FromFileTimeUtc($EndTimeUnix)

            # Format the DateTime as needed (e.g., to a readable string format)
            $FormattedStartTime = $StartTime.ToString("yyyy-MM-dd HH:mm:ss")
            $FormattedEndTime = $EndTime.ToString("yyyy-MM-dd HH:mm:ss")

            # Prepare the data to append to the CSV file
            $ReportData = "$ApplicationName, $EnvName, $SnapshotID, $SnapshotName, $UserName, $FormattedStartTime, $FormattedEndTime, $ComponentName, $ComponentVersion"

            # Add the data to the report
            Add-Content -Path $UCDReport.FullName -Value $ReportData
        }
    }
}

# Display the output
Write-Host "Report generated: $($UCDReport.FullName)"

